<!DOCTYPE html>
<html>
    <head>
        <title>Bilibili Data Logger</title>
        <meta charset="UTF-8">
        <!-- <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script> -->
        <script src="echarts.min.js"></script>
    </head>
    <body>
        <div id="chart" style="width: 90vw; height: 90vh;"></div>
        <div id="rate" style="width: 90vw; height: 90vh;"></div>
        <script>
            function setChart(container, data, customOption) {
                function deepMerge(target, source) {
                    for (let key in source) {
                        if (source.hasOwnProperty(key)) {
                            if (typeof source[key] === 'object' && source[key] !== null && !Array.isArray(source[key])) {
                                if (typeof target[key] !== 'object' || target[key] === null) {
                                    target[key] = {};
                                }
                                deepMerge(target[key], source[key]);
                            } else {
                                target[key] = source[key];
                            }
                        }
                    }
                    return target;
                }

                var chart = echarts.init(container);
                var option = {
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {},
                    dataset: {
                        source: []
                    },
                    xAxis: {
                        type: 'time',
                        axisLabel: {
                            formatter: '{yyyy}-{MM}-{dd}'
                        }
                    },
                    yAxis: {
                        scale: true
                    },
                    series: [
                        {
                            name: '播放量',
                            type: 'line',
                            encode: {x: 'date', y: 'view'}
                        },
                        {
                            name: '弹幕数',
                            type: 'line',
                            encode: {x: 'date', y: 'danmaku'}
                        },
                        {
                            name: '评论数',
                            type: 'line',
                            encode: {x: 'date', y: 'comment'}
                        },
                        {
                            name: '收藏数',
                            type: 'line',
                            encode: {x: 'date', y: 'favorite'}
                        },
                        {
                            name: '硬币数',
                            type: 'line',
                            encode: {x: 'date', y: 'coin'}
                        },
                        {
                            name: '分享数',
                            type: 'line',
                            encode: {x: 'date', y: 'share'}
                        },
                        {
                            name: '点赞数',
                            type: 'line',
                            encode: {x: 'date', y: 'like'}
                        }
                    ]
                };
                if (customOption) {
                    deepMerge(option, customOption);
                }
                console.log(option);
                const result = [["date", "view", "danmaku", "comment", "favorite", "coin", "share", "like"]];
                for (const [date, stats] of Object.entries(data)) {
                    result.push([date*1000, ...stats]);
                }
                option.dataset.source = result;
                chart.setOption(option);

                new ResizeObserver(chart.resize).observe(container);
            }

            const BVID = 'BV1Y7SWYpERP';
            fetch(`results/${BVID}.json`)
                .then(response => response.json())
                .then(json => {
                    setChart(document.getElementById('chart'), json, {
                        title: {
                            text: `${BVID} - 数据`,
                            link: `https://www.bilibili.com/video/${BVID}`
                        },
                        legend: {
                            selectedMode: 'single'
                        }
                    });

                    const data = Object.entries(json);
                    var rates = {};
                    for (let i in data) {
                        i = +i;
                        if (data[i + 1] !== undefined) {
                            rates[data[i + 1][0]] = data[i][1].map((value, index) => (data[i + 1][1][index] - value) / value);
                        }
                    }
                    setChart(document.getElementById('rate'), rates, {
                        title: {
                            text: `${BVID} - 增长率`,
                            link: `https://www.bilibili.com/video/${BVID}`
                        },
                        legend: {
                            selector: true,
                        },
                        tooltip: {
                            valueFormatter: (value) => `${(value*100).toFixed(3)}%`
                        },
                        yAxis: {
                            formatter: (value) => `${(value*100).toFixed(3)}%`
                        }
                    });
                });
        </script>
    </body>
</html>